# 简介

CAN（Controller Area Network）协议是一种用于车辆内部电子系统通信的串行通信协议，最初由Bosch公司在1980年代开发，用于汽车电子控制单元（ECU）之间的通信。随着时间的推移，CAN协议因其可靠性、灵活性和实时性而被广泛应用于工业自动化、医疗设备、船舶和航空电子等多个领域。

CAN协议的特点
1. 多主通信：
- CAN总线支持多主通信，即任何节点都可以主动发送数据。
- 通过仲裁机制解决多个节点同时发送数据的冲突问题。
2. 高可靠性：
- 采用差分信号传输，抗干扰能力强。
- 内置错误检测和故障隔离机制，确保通信的可靠性。
3. 实时性：
- 基于优先级的总线仲裁机制，确保高优先级消息能够快速传输。
4. 低成本：
- 使用双绞线作为传输介质，硬件成本低。
5. 帧格式：
- 标准帧（11位标识符）和扩展帧（29位标识符）。
- 数据帧最多可传输8字节数据。

CANFD（Controller Area Network Flexible Data-Rate）是CAN协议的升级版本，由博世公司在2012年发布。它在兼容传统CAN协议的基础上，提供了更高的数据传输速率和更大的数据帧容量，以满足现代汽车电子和工业控制系统的需求。目前存在两种CANFD标准，一种为Borsh标准（Non-ISO标准）和ISO标准。

CAN FD的主要特点
1.更高的数据传输速率：
- 仲裁段：使用与传统CAN相同的速率（通常为500 kbps或1 Mbps），以确保兼容性和可靠性。
- 数据段：可以切换到更高的速率（最高可达5 Mbps或更高），显著提高数据传输效率。
2.更大的数据帧容量：
- 数据帧的数据段可以扩展到64字节（传统CAN最多8字节），适用于传输更多数据的应用场景。
3. 改进的帧格式：
- 引入了FDF位（FD Format Indicator）：用于区分CAN FD帧和传统CAN帧。
- 引入了BRS位（Bit Rate Switch）：用于指示是否在数据段切换为更高的传输速率。
4. 增强的CRC校验：
- 使用更长的CRC校验码（17位或21位），以提高数据传输的可靠性。
5. 兼容性：
- CAN FD可以与传统CAN节点共存于同一网络中，便于系统升级和扩展。

# 标准

CAN协议经ISO标准化后由ISO11898和ISO11519-2两种标准。ISO11898和ISO11519-2标准对于数据链路层的定义相同，但物理层不同。

- ISO11898是通信速度为125Kbps-1Mbps的CAN高速通信标准
- ISO11519是通信速度为125Kbps以下的CAN低速通信标准

ISO11898和ISO11519-2标准物理层的主要不同点如下图：


ISO/OSI基本参照模型和CAN协议：


# 帧格式

CAN/CANFD存在标准帧和扩展帧两种帧格式。具体如下图所示：


# 帧类型

CAN协议共有5种帧类型，包括数据帧、远程帧、错误帧、过载帧和间隔帧，数据帧和遥控帧又有标准和扩展帧两种格式。

而CANFD协议只有4种帧类型，不存在远程帧。

## 数据帧

## 远程帧

## 错误帧

## 过载帧

过载条件：
- 帧间隔第一或第二位检测到显性电平
- 接收节点在EOF最后一位检测到显性电平
- 任何节点在错误帧界定符或者过载帧界定符最后一位检测到显性电平

## 间隔帧



# 优先级

# 错误检测及管理机制

## 错误检测

CAN/CANFD帧共有5种错误类型。

位错误（bit error）：发送节点在发送位时，检测到总线上的电平与它发送的电平不一致。以下情况不判定为位错误：
- 在仲裁期间，发送节点发送隐形电平但检测到显性电平
- 在ACK Slot期间，发送节点检测到显性电平
- 在发送被动错误标志期间，检测到显性电平

填充错误（stuff error）：接受节点在接收数据时，检测到连续的6个显性位。

CRC错误（crc error）：接收节点对比计算的CRC值和接收到的CRC值不一致；CANFD接收节点对比计算的填充计数位和接收到的填充计数位不一致。

格式错误（form error）：接收节点检测出与固定格式相反电平。以下情况判定位格式错误：
- 接收节点检测到CRC界定符位显性电平
- 接收节点检测到ACK界定符位显性电平
- 接收节点检测到EOF前6位出现显性电平，第7位为显性电平不判定位格式错误
- 接收节点检测到错误界定符前7位出现显性电平，第8位为显性电平不判定位格式错误
- 接收节点检测到过载界定符前7位出现显性电平，第8位为显性电平不判定位格式错误
- 接收节点检测到CANFD帧的CRC段的固定填充位电平与上一位电平一致判定位格式错误，而不是位填充错误

应答错误（ack error）：发送节点在ACK Slot期间，未检测到显性电平

## 错误管理机制

# 位时序

# 位填充

# 同步

# 发送延迟计算
